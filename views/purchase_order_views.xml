<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Vista de formulario extendida para órdenes de compra -->
        <record id="view_purchase_order_form_inherit_custom" model="ir.ui.view">
            <field name="name">purchase.order.form.custom</field>
            <field name="model">purchase.order</field>
            <field name="inherit_id" ref="purchase.purchase_order_form" />
            <field name="arch" type="xml">
                
                <!-- Agregar smart button para ver pagos directos -->
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button name="action_view_direct_payments" 
                            type="object" 
                            class="oe_stat_button" 
                            icon="fa-money"
                            invisible="direct_payment_count == 0">
                        <field name="direct_payment_count" widget="statinfo" string="Pagos Directos"/>
                    </button>
                </xpath>

                <!-- Agregar información de orden personalizada después del proveedor -->
                <xpath expr="//field[@name='partner_id']" position="after">
                    <!-- Usar departamentos nativos en lugar de selection -->
                    <field name="requesting_department_id" 
                           placeholder="Seleccionar departamento solicitante"
                           options="{'no_create_edit': True}"/>
                    <field name="supply_month" />
                </xpath>

                <!-- Agregar nueva pestaña para información específica -->
                <xpath expr="//notebook" position="inside">
                    <page string="Información de O. Compra" name="peruanita_info">
                        <group>
                            <group string="Control de Proceso">
                                <field name="elaborated_by" />
                                <field name="received_by" />
                            </group>
                            <group string="Aprobación Tesorería">
                                <field name="treasury_approval" />
                                <field name="treasury_approved_by" />
                                <field name="cancellation_dates" />
                            </group>
                        </group>
                        
                        <group>
                            <group string="Estado de Pago">
                                <field name="payment_status" widget="badge"
                                    decoration-danger="payment_status == 'no_paid'"
                                    decoration-warning="payment_status == 'partial'"
                                    decoration-success="payment_status == 'paid'"/>
                                <field name="total_paid_amount" widget="monetary"/>
                                <field name="payment_percentage" widget="percentage"/>
                                <label for="amount_total" string="Monto Total de la Orden"/>
                                <div>
                                    <field name="amount_total" widget="monetary" class="oe_inline"/>
                                </div>
                                <button name="action_recalculate_payment_status" 
                                        type="object" 
                                        string="Recalcular Estado" 
                                        class="btn-secondary"
                                        help="Fuerza el recálculo del estado de pago"/>
                            </group>
                            <group>
                                <div class="alert alert-info" role="alert" style="margin-bottom: 0px;">
                                    <p><strong>Información sobre el estado de pago:</strong></p>
                                    <ul style="margin-bottom: 0;">
                                        <li>Se consideran pagos de facturas confirmadas</li>
                                        <li>Se consideran pagos directos vinculados a esta O.C.</li>
                                        <li>Para vincular un pago a esta orden, use el campo "Orden de Compra" en el registro de pago</li>
                                    </ul>
                                </div>
                            </group>
                        </group>

                        <group string="Observaciones">
                            <field name="purchase_observations" nolabel="1" />
                        </group>

                        <group string="Firma (Documento)">
                            <field name="signature_image" widget="image" class="oe_avatar" options="{'preview_image': 'signature_image'}"/>
                            <p class="text-muted" style="font-size:11px; margin-top:5px;">Cargue aquí la imagen de la firma que se usará en el PDF (opcional).</p>
                        </group>

                        <group string="Información del Proveedor" name="supplier_info">
                            <!-- Mostrar información de contactos -->
                            <group string="Contacto de Compras">
                                <p class="text-muted">
                                    La información de contacto se obtiene automáticamente de los
                                    contactos relacionados al proveedor con función "Compras".
                                </p>
                            </group>
                            
                            <!-- Mostrar información bancaria -->
                            <group string="Cuenta Bancaria Principal">
                                <p class="text-muted">
                                    Los datos bancarios se obtienen de la cuenta marcada como 
                                    "Principal" en las cuentas bancarias del proveedor.
                                </p>
                            </group>
                        </group>
                    </page>
                </xpath>

            </field>
        </record>

        <!-- Vista de árbol/lista de órdenes de compra -->
        <record id="view_purchase_order_tree_receipt_status" model="ir.ui.view">
            <field name="name">purchase.order.tree.receipt.status</field>
            <field name="model">purchase.order</field>
            <field name="inherit_id" ref="purchase.purchase_order_kpis_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="supply_month" optional="show" />
                    <field name="destination_municipality_ids" widget="many2many_tags" optional="show" />
                </xpath>
                <field name="invoice_status" position="after">
                    <field name="receipt_status" widget="badge"
                        decoration-info="receipt_status == 'no'"
                        decoration-warning="receipt_status == 'partial'"
                        decoration-success="receipt_status == 'full'" optional="show"/>
                    <field name="payment_status" widget="badge"
                        decoration-danger="payment_status == 'no_paid'"
                        decoration-warning="payment_status == 'partial'"
                        decoration-success="payment_status == 'paid'" optional="show"/>
                </field>
            </field>
        </record>

        <!-- Vista de lista extendida -->
        <record id="view_purchase_order_tree_inherit_custom" model="ir.ui.view">
            <field name="name">purchase.order.tree.custom</field>
            <field name="model">purchase.order</field>
            <field name="inherit_id" ref="purchase.purchase_order_tree" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="requesting_department_id" optional="show" />
                    <field name="supply_month" optional="hide" />
                </xpath>
                <xpath expr="//field[@name='amount_total']" position="after">
                    <field name="payment_status" optional="show" />
                </xpath>
            </field>
        </record>

        <!-- Vista de búsqueda extendida -->
        <record id="view_purchase_order_filter_inherit_custom" model="ir.ui.view">
            <field name="name">purchase.order.search.custom</field>
            <field name="model">purchase.order</field>
            <field name="inherit_id" ref="purchase.view_purchase_order_filter" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='name']" position="after">
                    <field name="requesting_department_id" />
                    <field name="supply_month" />
                    <field name="destination_municipality_ids" string="Municipio Destino"/>
                </xpath>

                <xpath expr="//filter[@name='draft']" position="after">
                    <separator />
                    <filter string="No Pagado" name="filter_no_paid"
                        domain="[('payment_status', '=', 'no_paid')]" />
                    <filter string="Pago Parcial" name="filter_partial_payment"
                        domain="[('payment_status', '=', 'partial')]" />
                    <filter string="Pagado Completo" name="filter_paid"
                        domain="[('payment_status', '=', 'paid')]" />
                    <separator />
                    <filter string="Aprobado Tesorería" name="filter_treasury_approved"
                        domain="[('treasury_approval', '=', True)]" />
                </xpath>

                <xpath expr="//filter[@name='activities_exception']" position="inside">
                    <filter string="Por Departamento Solicitante" name="group_requesting_department"
                        domain="[]" context="{'group_by': 'requesting_department_id'}" />
                    <filter string="Por Mes de Abastecimiento" name="group_supply_month"
                        domain="[]" context="{'group_by': 'supply_month'}" />
                    <filter string="Por Estado de Pago" name="group_payment_status"
                        domain="[]" context="{'group_by': 'payment_status'}" />
                </xpath>
            </field>
        </record>
    </data>
</odoo>